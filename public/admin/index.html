<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Harvest Admin V2</title>
    <link rel="stylesheet" href="css/utilities.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    gridTemplateColumns: {
                        '7': 'repeat(7, minmax(0, 1fr))',
                    }
                }
            }
        }
    </script>
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="css/themes.css">
    <link rel="stylesheet" href="css/components/sidebar.css">
</head>

<body
    class="bg-gray-100 font-sans h-screen flex flex-col overflow-hidden dark:bg-gray-900 transition-colors duration-200">

    <!-- Navbar -->
    <nav
        class="bg-gray-900/90 backdrop-blur-md border-b border-white/10 px-6 py-3 flex justify-between items-center shadow-2xl shrink-0 relative z-30">
        <!-- Brand -->
        <div class="flex items-center gap-6">
            <div class="flex items-center gap-3">
                <div
                    class="w-9 h-9 rounded-xl bg-gradient-to-br from-emerald-500 to-green-700 flex items-center justify-center text-white font-bold text-lg shadow-[0_4px_12px_rgba(16,185,129,0.3)] border border-white/10">
                    H
                </div>
                <div class="flex flex-col">
                    <span class="text-lg font-bold tracking-tight text-white leading-tight">Harvest<span
                            class="text-emerald-400">Admin</span></span>
                    <span class="text-[10px] text-gray-400 tracking-wider font-medium">PREMIUM CONSOLE</span>
                </div>
            </div>

            <a href="/" target="_blank"
                class="hidden md:flex items-center gap-2 px-3 py-1.5 rounded-full bg-white/5 hover:bg-white/10 border border-white/5 hover:border-white/20 transition-all text-xs font-medium text-gray-300 hover:text-white group">
                <span>View Store</span>
                <svg class="w-3 h-3 text-gray-500 group-hover:text-emerald-400 transition-colors" fill="none"
                    stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                </svg>
            </a>
        </div>

        <!-- Right Controls -->
        <div class="flex items-center gap-5">

            <!-- Inventory Alert Indicator with Tooltip -->
            <div id="inventory-alert-indicator"
                class="hidden relative group flex items-center gap-2 px-3 py-1.5 bg-rose-500/10 border border-rose-500/20 rounded-full mr-2 cursor-pointer">
                <!-- Pulsing indicator elements -->
                <div class="w-1.5 h-1.5 rounded-full bg-rose-500 shadow-[0_0_8px_rgba(244,63,94,0.6)] animate-pulse">
                </div>
                <span class="text-[10px] font-bold text-rose-400 tracking-wide uppercase animate-pulse">Low Stock</span>

                <!-- Tooltip (appears on hover - no pulse) -->
                <div id="inventory-alert-tooltip"
                    class="absolute top-full left-0 mt-2 w-64 bg-gray-900 border border-gray-700 rounded-lg shadow-xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 z-50">
                    <div class="px-3 py-2 border-b border-gray-700">
                        <span class="text-xs font-bold text-rose-400 uppercase">Low Stock Items</span>
                    </div>
                    <ul id="inventory-alert-list" class="py-2 max-h-48 overflow-y-auto">
                        <!-- Populated by InventoryAlertService -->
                    </ul>
                </div>
            </div>

            <!-- User Info (Populated by JS) -->
            <div id="header-user-info" class="hidden items-center gap-4 pl-6 border-l border-white/10">
                <div class="text-right hidden md:block">
                    <div id="header-user-email" class="text-sm font-medium text-gray-200"></div>
                    <div id="header-user-role" class="text-[10px] font-bold uppercase tracking-wider text-gray-500">
                    </div>
                </div>
                <div
                    class="w-9 h-9 rounded-full bg-gray-800 border border-gray-700 flex items-center justify-center text-gray-400 shadow-sm relative">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                    </svg>
                    <div
                        class="absolute bottom-0 right-0 w-2.5 h-2.5 bg-green-500 border-2 border-gray-900 rounded-full">
                    </div>
                </div>
            </div>



            <!-- 3-State Theme Toggle -->
            <button data-action="app:cycleTheme"
                class="w-10 h-10 rounded-lg bg-gray-800 hover:bg-gray-700 flex items-center justify-center transition-all border border-gray-700 shadow-sm group relative overflow-hidden"
                id="theme-toggle-btn" title="Cycle Theme: Default > Minimal > Dark">

                <!-- Icon: Sun (Shows when in Default mode, click to go Minimal) -->
                <span id="icon-state-default"
                    class="text-yellow-400 absolute transition-all transform scale-100 opacity-100">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z">
                        </path>
                    </svg>
                </span>

                <!-- Icon: Square (Shows when in Minimal mode, click to go Dark) -->
                <span id="icon-state-minimal" class="text-white absolute transition-all transform scale-0 opacity-0">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 5a1 1 0 011-1h14a1 1 0 011 1v14a1 1 0 01-1 1H5a1 1 0 01-1-1V5z"></path>
                    </svg>
                </span>

                <!-- Icon: Moon (Shows when in Dark mode, click to go Terminal) -->
                <span id="icon-state-dark" class="text-blue-300 absolute transition-all transform scale-0 opacity-0">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z">
                        </path>
                    </svg>
                </span>

                <!-- Icon: Terminal (Shows when in Terminal mode, click to go Default) -->
                <span id="icon-state-terminal"
                    class="text-green-500 absolute transition-all transform scale-0 opacity-0 font-mono font-bold text-lg">
                    >_
                </span>
            </button>

            <!-- Logout -->
            <button data-action="app:logout"
                class="text-xs bg-red-500/10 hover:bg-red-500/20 text-red-400 hover:text-red-300 px-3 py-1.5 rounded-lg border border-red-500/20 transition-all font-medium">
                Logout
            </button>
        </div>
    </nav>

    <!-- Main Layout -->
    <div class="flex flex-1 overflow-hidden">

        <!-- Sidebar Container -->
        <div id="sidebar-container"></div>

        <!-- Content -->
        <main class="flex-1 overflow-auto bg-gray-50 p-8">



            <!-- DASHBOARD VIEW -->
            <div id="view-dashboard" class="hidden">
                <!-- Content loaded dynamically from views/dashboard.html -->
                <div class="flex items-center justify-center p-12 text-gray-400">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mr-3"></div>
                    <span>Loading Dashboard...</span>
                </div>
            </div>

            <!-- INVENTORY VIEW -->
            <div id="view-inventory" class="hidden space-y-4">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-gray-800">Inventory Management</h2>
                    <div class="text-sm text-gray-500">Real-time stock updates</div>
                </div>
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                    <table class="w-full text-left">
                        <thead class="bg-gray-50 border-b border-gray-100">
                            <th data-action="inventory:sort" data-field="id"
                                class="p-4 text-xs font-semibold text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 transition-colors select-none group">
                                ID <span id="sort-arrow-id" class="invisible group-hover:visible ml-1">↕</span>
                            </th>
                            <th data-action="inventory:sort" data-field="name"
                                class="p-4 text-xs font-semibold text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 transition-colors select-none group">
                                Product <span id="sort-arrow-name" class="invisible group-hover:visible ml-1">↕</span>
                            </th>
                            <th data-action="inventory:sort" data-field="farm_id"
                                class="p-4 text-xs font-semibold text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 transition-colors select-none group">
                                Farm ID <span id="sort-arrow-farm_id"
                                    class="invisible group-hover:visible ml-1">↕</span>
                            </th>
                            <th data-action="inventory:sort" data-field="price"
                                class="p-4 text-xs font-semibold text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 transition-colors select-none group">
                                Price <span id="sort-arrow-price" class="invisible group-hover:visible ml-1">↕</span>
                            </th>
                            <th data-action="inventory:sort" data-field="stock"
                                class="p-4 text-xs font-semibold text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 transition-colors select-none group">
                                Stock <span id="sort-arrow-stock" class="invisible group-hover:visible ml-1">↕</span>
                            </th>
                            <th class="p-4 text-xs font-semibold text-gray-500 uppercase tracking-wider text-right">
                                Actions</th>
                        </thead>
                        <tbody id="inventory-list" class="divide-y divide-gray-100"></tbody>
                    </table>
                </div>
            </div>

            <!-- ORDERS VIEW -->
            <div id="view-orders" class="hidden">
                <div class="flex items-center justify-center p-12 text-gray-400">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mr-3"></div>
                    <span>Loading Orders...</span>
                </div>
            </div>

            <!-- CUSTOMERS/USER MANAGEMENT VIEW -->
            <div id="view-customers" class="hidden space-y-4">
                <div class="flex items-center justify-center p-12 text-gray-400">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mr-3"></div>
                    <span>Loading User Management...</span>
                </div>
            </div>

            <!-- PRODUCTS VIEW -->
            <div id="view-products" class="hidden">
                <div class="flex items-center justify-center p-12 text-gray-400">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mr-3"></div>
                    <span>Loading Products...</span>
                </div>
            </div>
            <!-- ARCHIVED PRODUCTS VIEW -->
            <div id="view-archived" class="hidden">
                <div class="flex items-center justify-center p-12 text-gray-400">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mr-3"></div>
                    <span>Loading Archived Items...</span>
                </div>
            </div>

            <!-- CATEGORIES VIEW -->
            <div id="view-categories" class="hidden space-y-6">
                <!-- Content loaded dynamically from views/categories.html -->
                <div class="flex items-center justify-center p-12 text-gray-400">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mr-3"></div>
                    <span>Loading Categories & Tags...</span>
                </div>
            </div>

            <!-- TEMPLATES VIEW -->
            <div id="view-templates" class="hidden">
                <div class="flex items-center justify-center p-12 text-gray-400">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mr-3"></div>
                    <span>Loading Templates...</span>
                </div>
            </div>

            <!-- DELIVERY VIEW -->
            <div id="view-delivery" class="hidden space-y-8">
                <!-- Content loaded dynamically from views/delivery.html -->
                <div class="flex items-center justify-center p-12 text-gray-400">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mr-3"></div>
                    <span>Loading Delivery Schedule...</span>
                </div>
            </div>


            <!-- SETTINGS/CONFIG VIEW (Refactored with Tabs) -->
            <div id="view-settings" class="hidden pb-32 w-full max-w-7xl mx-auto">
                <!-- Settings content loaded dynamically from views/settings.html -->
                <div class="flex items-center justify-center p-12 text-gray-400">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mr-3"></div>
                    <span>Loading Configuration...</span>
                </div>
            </div>

            <!-- ADMIN UTILITIES VIEW -->
            <div id="view-utilities" class="hidden space-y-6">
                <!-- Content loaded dynamically from views/utilities.html -->
                <div class="flex items-center justify-center p-12 text-gray-400">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mr-3"></div>
                    <span>Initializing Master Terminals...</span>
                </div>
            </div>

            <!-- LAYOUT EDITOR VIEW -->
            <div id="view-layouts" class="hidden space-y-6">
                <!-- Layout content loaded dynamically from views/layouts.html -->
                <div class="flex items-center justify-center p-12 text-gray-400">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mr-3"></div>
                    <span>Loading Layout Editor...</span>
                </div>
            </div>

            <!-- ANALYTICS VIEW -->
            <div id="view-analytics" class="hidden space-y-6">
                <!-- Analytics content loaded dynamically from views/analytics.html -->
                <div class="flex items-center justify-center p-12 text-gray-400">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mr-3"></div>
                    <span>Initializing Analytics Dashboard...</span>
                </div>
            </div>

        </main>
    </div>


    <!-- Toast Container -->
    <div id="toast-container" class="fixed bottom-6 right-6 space-y-4 z-50"></div>



    <!-- USER MODAL (Now loaded dynamically in view-customers) -->


    <!-- PRODUCT & TEMPLATE MODALS (loaded dynamically from views/product-modals.html) -->
    <div id="product-modals-container"></div>

    <!-- ORDER MODALS (loaded dynamically from views/order-modals.html) -->
    <div id="order-modals-container"></div>

    <!-- State Suggestions -->
    <datalist id="us-states-admin">
        <option value="AL">
        <option value="AK">
        <option value="AZ">
        <option value="AR">
        <option value="CA">
        <option value="CO">
        <option value="CT">
        <option value="DE">
        <option value="FL">
        <option value="GA">
        <option value="HI">
        <option value="ID">
        <option value="IL">
        <option value="IN">
        <option value="IA">
        <option value="KS">
        <option value="KY">
        <option value="LA">
        <option value="ME">
        <option value="MD">
        <option value="MA">
        <option value="MI">
        <option value="MN">
        <option value="MS">
        <option value="MO">
        <option value="MT">
        <option value="NE">
        <option value="NV">
        <option value="NH">
        <option value="NJ">
        <option value="NM">
        <option value="NY">
        <option value="NC">
        <option value="ND">
        <option value="OH">
        <option value="OK">
        <option value="OR">
        <option value="PA">
        <option value="RI">
        <option value="SC">
        <option value="SD">
        <option value="TN">
        <option value="TX">
        <option value="UT">
        <option value="VT">
        <option value="VA">
        <option value="WA">
        <option value="WV">
        <option value="WI">
        <option value="WY">
    </datalist>
    <!-- LAYOUT MODALS CONTAINER -->
    <div id="layout-modals-container"></div>

    <!-- LOGIN MODAL -->
    <div id="login-modal" style="display: none;" class="fixed inset-0 bg-gray-900 z-[100] items-center justify-center">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-8">
            <div class="text-center mb-8">
                <h2 class="text-2xl font-bold text-gray-900">Admin Login</h2>
                <p class="text-gray-500 text-sm mt-2">Please sign in to continue</p>
            </div>
            <form onsubmit="handleLogin(event)" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                    <input type="email" id="login-email" name="email" autocomplete="email" required
                        class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 outline-none transition-all">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                    <input type="password" id="login-password" name="password" autocomplete="current-password" required
                        class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 outline-none transition-all">
                </div>
                <button type="submit"
                    class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition-colors shadow-lg">
                    Sign In
                </button>
            </form>
        </div>
    </div>

    <script type="module" src="js/modules/app.js"></script>
    <script>
        // 4-State Theme Logic: default -> minimal -> johndeere -> terminal -> default
        const THEME_STATES = ['default', 'minimal', 'johndeere', 'terminal'];

        function cycleTheme() {
            const current = getCurrentTheme();
            const idx = THEME_STATES.indexOf(current);
            const next = THEME_STATES[(idx + 1) % THEME_STATES.length];
            applyTheme(next);
        }

        function getCurrentTheme() {
            return localStorage.getItem('admin_theme_v2') || 'default';
        }

        function applyTheme(theme) {
            const body = document.body;
            const html = document.documentElement;

            // Reset
            body.classList.remove('theme-minimal', 'theme-terminal', 'theme-johndeere');
            html.classList.remove('dark');

            // Apply
            if (theme === 'minimal') {
                body.classList.add('theme-minimal');
            } else if (theme === 'johndeere') {
                body.classList.add('theme-johndeere');
            } else if (theme === 'terminal') {
                body.classList.add('theme-terminal');
            }

            // Save
            localStorage.setItem('admin_theme_v2', theme);
            updateThemeUI(theme);
        }

        function updateThemeUI(theme) {
            // Icons
            const icons = {
                default: document.getElementById('icon-state-default'),
                minimal: document.getElementById('icon-state-minimal'),
                johndeere: document.getElementById('icon-state-default'), // Fallback to sun for JD
                terminal: document.getElementById('icon-state-terminal')
            };

            // Reset all icons
            Object.values(icons).forEach(icon => {
                if (!icon) return;
                icon.classList.remove('scale-100', 'opacity-100');
                icon.classList.add('scale-0', 'opacity-0');
            });

            // Show active
            if (icons[theme]) {
                icons[theme].classList.remove('scale-0', 'opacity-0');
                icons[theme].classList.add('scale-100', 'opacity-100');
            }

            // Button Context
            const btn = document.getElementById('theme-toggle-btn');

            // Minimal: Black button
            if (theme === 'minimal') {
                btn.classList.add('bg-black', 'text-white', 'border-black');
                btn.classList.remove('bg-gray-800', 'border-green-500', 'text-green-500', 'bg-yellow-400', 'border-green-700', 'text-green-900');
            }
            // Terminal: Black button with Green Border
            else if (theme === 'terminal') {
                btn.classList.add('bg-black', 'text-green-500', 'border-green-500');
                btn.classList.remove('bg-gray-800', 'text-white', 'border-black', 'bg-yellow-400', 'border-green-700', 'text-green-900');
            }
            // John Deere: Yellow Button
            else if (theme === 'johndeere') {
                btn.classList.add('bg-yellow-400', 'border-green-700', 'text-green-900');
                btn.classList.remove('bg-gray-800', 'text-white', 'border-black', 'bg-black', 'border-green-500', 'text-green-500');
            }
            // Default: Gray button
            else {
                btn.classList.remove('bg-black', 'text-white', 'border-black', 'border-green-500', 'text-green-500', 'bg-yellow-400', 'border-green-700', 'text-green-900');
                btn.classList.add('bg-gray-800');
            }
        }

        // Init Theme
        document.addEventListener('DOMContentLoaded', () => {
            applyTheme(getCurrentTheme());
        });
    </script>
    <!-- UX Enhancements Script -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Auto-resize textareas on focus/input
            // AND Expand Inputs on focus
            const expandable = document.querySelectorAll('textarea, input[type="text"]:not(#new-cat-name)');

            expandable.forEach(el => {
                el.classList.add('expand-on-focus', 'expand-transition');

                // Textarea specific height logic
                if (el.tagName === 'TEXTAREA') {
                    el.addEventListener('focus', function () {
                        this.dataset.originalHeight = this.style.height;
                    });
                    el.addEventListener('blur', function () {
                        this.scrollTop = 0;
                    });
                }

                // Input specific logic (ensure parent relative for absolute positioning)
                if (el.tagName === 'INPUT') {
                    // Ensure parent has relative positioning for the absolute expansion to work near it
                    const parent = el.parentElement;
                    if (parent && getComputedStyle(parent).position === 'static') {
                        parent.style.position = 'relative';
                    }
                }
            });
        });
    </script>

    <!-- Modal Orientation Functions -->
    <script>
        function saveModalOrientation(orientation) {
            localStorage.setItem('admin_modal_orientation', orientation);
            applyModalOrientation();
            showToast(`Modal orientation set to ${orientation}`, 'success');
        }

        function applyModalOrientation() {
            const orientation = localStorage.getItem('admin_modal_orientation') || 'vertical';
            const modalContent = document.querySelector('#user-modal .grid');

            if (modalContent) {
                if (orientation === 'horizontal') {
                    // 1-column layout
                    modalContent.classList.remove('md:grid-cols-2');
                    modalContent.classList.add('grid-cols-1');
                } else {
                    // 2-column layout (default)
                    modalContent.classList.remove('grid-cols-1');
                    modalContent.classList.add('md:grid-cols-2');
                }
            }

            // Update dropdown if on config page
            const select = document.getElementById('cfg-modal-orientation');
            if (select) {
                select.value = orientation;
            }
        }

        // Apply on page load
        document.addEventListener('DOMContentLoaded', () => {
            applyModalOrientation();
        });

        // Make globally available
        window.saveModalOrientation = saveModalOrientation;
    </script>
    <script type="module" src="/admin/js/components/ChoiceModal.js"></script>

    <!-- Sidebar Component -->
    <script src="js/components/Sidebar.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const config = Sidebar.getDefaultConfig();
            window.sidebar = new Sidebar('sidebar-container', config);

            // Sync active state if tab is set via hash on load
            const hash = window.location.hash.slice(1);
            if (hash) {
                window.sidebar.activeTabId = hash;
                window.sidebar.updateActiveState();
            }
        });

        // Sync sidebar on external setTab calls (via hashchange)
        window.addEventListener('hashchange', () => {
            const tabName = window.location.hash.slice(1);
            if (tabName && window.sidebar) {
                window.sidebar.activeTabId = tabName;
                window.sidebar.updateActiveState();
            }
        });
    </script>

    <!-- Gemini AI Logic -->
    <script type="module">
        import { generateContent, applyGeminiChoice } from '/admin/js/modules/gemini.js';
        window.generateContent = generateContent;
        window.applyGeminiChoice = applyGeminiChoice;
    </script>
</body>

</html>